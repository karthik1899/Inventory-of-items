<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Walkie Talkie Manager</title>
  <style>
    :root{
      --bg: #f6f8fb;
      --card: #ffffff;
      --accent: #2563eb;
      --muted: #6b7280;
      --success: #10b981;
      --danger: #ef4444;
      --shadow: 0 6px 20px rgba(15,23,42,0.08);
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    body{margin:0;padding:24px;background:linear-gradient(180deg,#eef2ff 0%,var(--bg) 100%);color:#0f172a;}
    header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:18px;}
    header h1{margin:0;font-size:20px;letter-spacing:-0.2px;}
    .controls{display:flex;gap:8px;align-items:center;}
    .btn{background:var(--accent);color:white;padding:8px 12px;border-radius:8px;border:none;cursor:pointer;box-shadow:var(--shadow);font-weight:600;}
    .btn.ghost{background:transparent;color:var(--accent);border:1px solid rgba(37,99,235,0.12);}
    .grid{display:grid;grid-template-columns: repeat(3, 1fr);gap:16px;align-items:start;}
    .column{background:var(--card);border-radius:12px;padding:12px;box-shadow:var(--shadow);min-height:280px;display:flex;flex-direction:column;}
    .col-header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:8px;}
    .col-title{display:flex;gap:8px;align-items:center;}
    .badge{background: rgba(37,99,235,0.1);color: var(--accent);padding:6px 8px;border-radius:999px;font-weight:700;min-width:46px;text-align:center;}
    .list{list-style:none;margin:0;padding:0;overflow:auto;max-height:540px;}
    .item{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:8px;border-radius:8px;transition:transform .12s ease, box-shadow .12s;background:linear-gradient(180deg, rgba(15,23,42,0.02), transparent);margin-bottom:8px;}
    .item:hover{transform:translateY(-3px);box-shadow:0 8px 22px rgba(2,6,23,0.06);}
    .item .left{display:flex;align-items:center;gap:10px}
    .dot{width:36px;height:36px;border-radius:8px;display:grid;place-items:center;font-weight:700;background:linear-gradient(180deg,#fff,#f3f4f6);border:1px solid rgba(15,23,42,0.04);color:#111827;}
    .meta{font-size:13px;color:var(--muted)}
    .actions{display:flex;gap:6px;align-items:center}
    .small-btn{padding:6px 8px;border-radius:8px;border:1px solid rgba(15,23,42,0.06);background:white;cursor:pointer;font-weight:600;}
    select{padding:6px;border-radius:8px;border:1px solid rgba(15,23,42,0.06)}
    .footer{margin-top:12px;display:flex;justify-content:space-between;align-items:center;gap:12px;font-size:13px;color:var(--muted);}
    @media (max-width:900px){ .grid{grid-template-columns: 1fr;} }
    .empty{padding:14px;border-radius:10px;background:linear-gradient(180deg,rgba(15,23,42,0.02),transparent);text-align:center;color:var(--muted);font-style:italic;}
    .file-input{display:none;}
  </style>
</head>
<body>
  <header>
    <h1>Walkie Talkie Manager</h1>
    <div class="controls">
      <div style="font-size:13px;color:var(--muted)">Total Walkies: <strong id="totalLabel">55</strong></div>
      <button class="btn" id="resetBtn" title="Reset everything to initial state">Reset</button>
      <button class="btn ghost" id="exportBtn" title="Export current allocation as JSON">Export</button>
      <label class="btn ghost" style="cursor:pointer">
        Upload
        <input id="uploadFile" class="file-input" type="file" accept="application/json" />
      </label>
    </div>
  </header>

  <div class="grid" id="grid"></div>

  <script>
    // --- Configuration ---
    const TOTAL = 55;
    const DATA_FILE = 'data.json'; // file placed in repo root
    const STORAGE_KEY = 'walkie_allocator_v1';

    // state
    let walkies = [];

    // columns
    const columns = {
      inhand: { title: 'In Hand', key: 'inhand' },
      mainline: { title: 'Mainline Crew', key: 'mainline' },
      juggler: { title: 'Juggler Crew', key: 'juggler' }
    };

    // Save/load to localStorage
    function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(walkies)); }
    function loadLocalState(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if(raw){
        try{
          const parsed = JSON.parse(raw);
          if(Array.isArray(parsed) && parsed.length===TOTAL){
            walkies = parsed;
            return true;
          }
        }catch(e){}
      }
      return false;
    }

    // Create default state
    function createDefault(){
      walkies = [];
      for(let i=1;i<=TOTAL;i++){
        walkies.push({ id: i, name: 'Walkie-' + i, loc: 'inhand' });
      }
    }

    // Try fetch data.json; fallback to localStorage, then to default
    async function initialize(){
      // Try to fetch data.json first (prefer repo-provided initial JSON)
      try{
        const resp = await fetch(DATA_FILE, {cache: 'no-cache'});
        if(resp.ok){
          const j = await resp.json();
          // Accept either array of items or object with total/inHand/etc.
          if(Array.isArray(j) && j.length === TOTAL && j[0].id){
            walkies = j.map(x => ({ id: Number(x.id), name: x.name || ('Walkie-' + x.id), loc: x.loc || 'inhand' }));
            saveState();
            render();
            return;
          } else if (typeof j === 'object' && (j.total || j.inHand || j.inhand)) {
            // support earlier schema { total, inHand, mainline, juggler }
            const inhand = Number(j.inhand ?? j.inHand ?? j.inHand ?? 0) || 0;
            const mainline = Number(j.mainline ?? 0) || 0;
            const juggler = Number(j.juggler ?? 0) || 0;
            // build list preserving IDs 1..TOTAL, assign first N to inhand, etc.
            walkies = [];
            let id = 1;
            for(let i=0;i<inhand;i++){ walkies.push({ id: id++, name: 'Walkie-' + (id-1), loc: 'inhand' }); }
            for(let i=0;i<mainline;i++){ walkies.push({ id: id++, name: 'Walkie-' + (id-1), loc: 'mainline' }); }
            for(let i=0;i<juggler;i++){ walkies.push({ id: id++, name: 'Walkie-' + (id-1), loc: 'juggler' }); }
            // If less/padded, fill remaining as inhand
            while(walkies.length < TOTAL){ walkies.push({ id: ++id-1, name: 'Walkie-' + (id-1), loc: 'inhand' }); }
            // ensure correct IDs 1..TOTAL
            walkies = walkies.slice(0, TOTAL).map((w, idx) => ({ id: idx+1, name: w.name || ('Walkie-'+(idx+1)), loc: w.loc }));
            saveState();
            render();
            return;
          }
        }
      }catch(e){
        // fetch failed — probably data.json not present or blocked; fallback below
      }

      // If fetch didn't produce usable state, try localStorage
      if(loadLocalState()){
        render();
        return;
      }

      // Last fallback: default generated state
      createDefault();
      saveState();
      render();
    }

    // Render UI
    const grid = document.getElementById('grid');
    const totalLabel = document.getElementById('totalLabel');
    function render(){
      grid.innerHTML = '';
      totalLabel.textContent = TOTAL;
      for(const colKey of Object.keys(columns)){
        const col = document.createElement('div');
        col.className = 'column';
        col.dataset.col = colKey;

        const header = document.createElement('div');
        header.className = 'col-header';
        const titleWrap = document.createElement('div');
        titleWrap.className = 'col-title';
        titleWrap.innerHTML = `<strong>${columns[colKey].title}</strong>`;
        const badge = document.createElement('div');
        badge.className = 'badge';
        badge.id = `count-${colKey}`;
        header.appendChild(titleWrap);
        header.appendChild(badge);

        const list = document.createElement('ul');
        list.className = 'list';
        list.id = `list-${colKey}`;

        const items = walkies.filter(w => w.loc === colKey);
        badge.textContent = items.length;

        if(items.length === 0){
          const empty = document.createElement('div');
          empty.className = 'empty';
          empty.textContent = 'No walkies here';
          list.appendChild(empty);
        } else {
          for(const w of items){
            const li = document.createElement('li');
            li.className = 'item';
            li.dataset.id = w.id;

            const left = document.createElement('div');
            left.className = 'left';
            left.innerHTML = `<div class="dot">${w.id}</div><div><div style="font-weight:700">${w.name}</div><div class="meta">ID: ${w.id}</div></div>`;

            const actions = document.createElement('div');
            actions.className = 'actions';

            const sel = document.createElement('select');
            sel.title = 'Move to...';
            const opts = [
              {val:'inhand', txt:'In Hand'},
              {val:'mainline', txt:'Mainline Crew'},
              {val:'juggler', txt:'Juggler Crew'}
            ];
            for(const o of opts){
              if(o.val === w.loc) continue;
              const op = document.createElement('option');
              op.value = o.val;
              op.textContent = o.txt;
              sel.appendChild(op);
            }
            actions.appendChild(sel);

            const moveBtn = document.createElement('button');
            moveBtn.className = 'small-btn';
            moveBtn.textContent = 'Move';
            moveBtn.title = 'Move this walkie to the selected column';
            moveBtn.onclick = () => {
              const to = sel.value;
              moveWalkie(w.id, to);
            };

            const backBtn = document.createElement('button');
            backBtn.className = 'small-btn';
            backBtn.textContent = 'Return';
            backBtn.title = 'Return to In Hand';
            backBtn.onclick = () => moveWalkie(w.id, 'inhand');

            if(w.loc === 'inhand'){
              actions.appendChild(moveBtn);
              const quickM = document.createElement('button');
              quickM.className = 'small-btn';
              quickM.textContent = '→ Mainline';
              quickM.onclick = ()=>moveWalkie(w.id,'mainline');
              const quickJ = document.createElement('button');
              quickJ.className = 'small-btn';
              quickJ.textContent = '→ Juggler';
              quickJ.onclick = ()=>moveWalkie(w.id,'juggler');
              actions.appendChild(quickM);
              actions.appendChild(quickJ);
            } else {
              actions.appendChild(moveBtn);
              actions.appendChild(backBtn);
            }

            li.appendChild(left);
            li.appendChild(actions);
            list.appendChild(li);
          }
        }

        const footer = document.createElement('div');
        footer.className = 'footer';
        footer.innerHTML = `<div class="meta">Showing ${items.length} items</div>`;

        col.appendChild(header);
        col.appendChild(list);
        col.appendChild(footer);
        grid.appendChild(col);
      }
      saveState();
    }

    // Operations
    function moveWalkie(id, to){
      id = Number(id);
      const w = walkies.find(x => x.id === id);
      if(!w) return;
      if(w.loc === to) return;
      w.loc = to;
      render();
    }

    function resetState(){
      if(!confirm('Reset all walkies to In Hand?')) return;
      createDefault();
      saveState();
      render();
    }

    function exportJSON(){
      const data = JSON.stringify(walkies, null, 2);
      const blob = new Blob([data], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'walkie-allocation.json';
      a.click();
      URL.revokeObjectURL(url);
    }

    // Upload handler - accepts either array of items or {inHand,mainline,juggler}
    document.getElementById('uploadFile').addEventListener('change',(e)=>{
      const f = e.target.files[0];
      if(!f) return;
      const r = new FileReader();
      r.onload = ()=>{
        try{
          const obj = JSON.parse(r.result);
          // If array of walkies
          if(Array.isArray(obj) && obj.length === TOTAL && obj[0].id){
            walkies = obj.map(x => ({ id: Number(x.id), name: x.name || ('Walkie-'+x.id), loc: x.loc || 'inhand' }));
            saveState(); render(); return;
          }
          // If object with counts
          if(obj && (obj.inhand || obj.inHand || obj.mainline || obj.juggler)){
            const inhand = Number(obj.inhand ?? obj.inHand ?? 0) || 0;
            const mainline = Number(obj.mainline ?? 0) || 0;
            const juggler = Number(obj.juggler ?? 0) || 0;
            walkies = [];
            let id = 1;
            for(let i=0;i<inhand;i++) walkies.push({ id: id++, name: 'Walkie-'+(id-1), loc: 'inhand' });
            for(let i=0;i<mainline;i++) walkies.push({ id: id++, name: 'Walkie-'+(id-1), loc: 'mainline' });
            for(let i=0;i<juggler;i++) walkies.push({ id: id++, name: 'Walkie-'+(id-1), loc: 'juggler' });
            while(walkies.length < TOTAL) walkies.push({ id: walkies.length+1, name: 'Walkie-'+(walkies.length+1), loc: 'inhand' });
            walkies = walkies.slice(0, TOTAL).map((w, idx) => ({ id: idx+1, name: w.name || ('Walkie-'+(idx+1)), loc: w.loc }));
            saveState(); render(); return;
          }
          alert('JSON file not in expected format.');
        }catch(err){
          alert('Invalid JSON file.');
        }
      };
      r.readAsText(f);
      // clear file input so same file can be uploaded again later
      e.target.value = '';
    });

    // keyboard shortcut (Ctrl/Cmd+R will trigger browser reload - we use Ctrl/Cmd+Shift+R)
    document.addEventListener('keydown', e=>{
      if(e.key === 'r' && (e.ctrlKey && e.shiftKey)) { e.preventDefault(); resetState(); }
    });

    // wire up UI buttons
    document.getElementById('resetBtn').addEventListener('click', resetState);
    document.getElementById('exportBtn').addEventListener('click', exportJSON);

    // initialize
    initialize();
  </script>
</body>
</html>
